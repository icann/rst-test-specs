#!/bin/bash

SITEDIR="_site"

rm -rf "$SITEDIR"
mkdir "$SITEDIR"

git config --global --add safe.directory /app

CURRENT_RELEASE="$(git tag | tail -1)"

if [ -z "$CURRENT_RELEASE" ] ; then
    echo "No release tag found! Tag list follows..."
    git tag --list
    exit 1
fi

echo "Current release is $CURRENT_RELEASE"

echo "Creating index file..."
gpp -x "-DRELEASE=$CURRENT_RELEASE" etc/index.md | pandoc \
    --from markdown \
    --to html \
    --standalone \
    --embed-resources=true \
    --metadata title="ICANN Registry System Testing (RST) Test Specifications" \
    --css=inc/html/style.css \
    --output="$SITEDIR/index.html"

gpp -x "-DRELEASE=$CURRENT_RELEASE" etc/test-spec-redirect.html > "$SITEDIR/rst-test-specs.html"

echo "Syncing historical releases..."
pushd "$SITEDIR" > /dev/null
curl -s https://api.github.com/repos/icann/rst-test-specs/releases | \
    jq -r '.[] | .assets[] | .browser_download_url' | \
    wget \
        --mirror \
        --quiet \
        --input-file - \
        --no-host-directories \
        --cut-dirs 4
popd > /dev/null

echo "Generating EPP extension data..."
mkdir "$SITEDIR/epp-extensions"
yq -o json epp-extensions/epp-extensions.yaml > "$SITEDIR/epp-extensions/epp-extensions.json"
cp -R epp-extensions/xsd "$SITEDIR/epp-extensions/"
tools/generate-superschema.pl > "$SITEDIR/epp-extensions/xsd/super.xsd"

cp rdapct_config*.json "$SITEDIR/"

chmod -R 0755 "$SITEDIR"

echo "done"
